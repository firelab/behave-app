name: Build and Package

on: push
#  push:
#    tags:
#      - '*'

jobs:
  build-all:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Cache Nix store
        if: ${{ !env.ACT }}
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Cache Clojure and Conveyor dependencies
        if: ${{ !env.ACT }}
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
            ~/.conveyor-cache
          key: deps-${{ hashFiles('**/deps.edn', '**/conveyor.conf') }}
          restore-keys: |
            deps-

      - name: Set the version
        run: |
          VERSION=$(echo ${{ github.ref }} | sed -e 's/refs\/tags\///g')
          echo "version=$VERSION" >> "$GITHUB_ENV"

      - name: Set the date
        run: |
          DATE=$(date '+%Y-%m-%d')
          echo "date=$DATE" >> "$GITHUB_ENV"

      - name: Build JAR and Conveyor packages
        env:
          VMS_URL: ${{ secrets.VMS_URL }}
          VMS_AUTH_TOKEN: ${{ secrets.VMS_AUTH_TOKEN }}
          CONVEYOR_CACHE_PATH: ~/.conveyor-cache
        run: |
          cd projects/behave

          # Create cache directory
          mkdir -p "$CONVEYOR_CACHE_PATH"
          export NIXPKGS_ALLOW_UNFREE=1

          # Use Nix development environment to build everything
          nix develop --impure --command bash -c "
            clojure -X:download-vms :url '$VMS_URL' :auth-token '$VMS_AUTH_TOKEN'
            bb build-js
            mv resources/config.standalone.edn resources/config.edn
            echo '{:version \"$version\"}' > resources/version.edn
            bb conveyor
          "

      - name: List built artifacts
        run: |
          echo "=== JAR files ==="
          ls -lh projects/behave/target/*.jar || true
          echo "=== Conveyor output ==="
          ls -lh projects/behave/output/ || true
          find projects/behave/output -type f

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: behave7-jar
          path: projects/behave/target/behave7*.jar
          retention-days: 5

      - name: Upload Windows package
        uses: actions/upload-artifact@v4
        with:
          name: windows-zip
          path: projects/behave/output/**/*windows*.zip
          retention-days: 5

      - name: Upload macOS packages
        uses: actions/upload-artifact@v4
        with:
          name: mac-app-zip
          path: projects/behave/output/**/*mac*.zip
          retention-days: 5

      - name: Upload Linux package
        uses: actions/upload-artifact@v4
        with:
          name: debian-package
          path: projects/behave/output/**/*.deb
          retention-days: 5

  # sign-windows:
  #   needs: build-all
  #   runs-on: ubuntu-latest

  #   steps:
  #     - name: Download Windows package
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: windows-zip
  #         path: windows-package/

  #     - name: Find Windows zip file
  #       id: find-zip
  #       run: |
  #         ZIP_FILE=$(find windows-package -name "*windows*.zip" -type f | head -1)
  #         echo "zip-file=$ZIP_FILE" >> $GITHUB_OUTPUT
  #         echo "Found zip file: $ZIP_FILE"

  #     - name: Sign Windows package
  #       uses: rjsheperd/az-jsign-trusted-signing@main
  #       with:
  #         file: ${{ steps.find-zip.outputs.zip-file }}
  #         alias: ${{ secrets.AZURE_SIGNING_ALIAS }}
  #         region: ${{ secrets.AZURE_SIGNING_REGION }}
  #         azure-tenant-id: ${{ secrets.AZURE_TENANT_ID }}
  #         azure-client-id: ${{ secrets.AZURE_CLIENT_ID }}
  #         azure-client-secret: ${{ secrets.AZURE_CLIENT_SECRET }}

  #     - name: Upload signed Windows package
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: windows-zip-signed
  #         path: windows-package/**
  #         retention-days: 5

  create-release:
    # needs: [build-all, sign-windows]
    needs: [build-all]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set version
        run: |
          VERSION=$(echo ${{ github.ref }} | sed -e 's/refs\/tags\///g')
          echo "version=$VERSION" >> "$GITHUB_ENV"
          DATE=$(date '+%Y-%m-%d')
          echo "date=$DATE" >> "$GITHUB_ENV"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts/

      - name: Display structure
        run: ls -R release-artifacts/

      - name: Rename JAR
        run: |
          cd release-artifacts/behave7-jar
          # Find the JAR file and rename it with version
          JAR_FILE=$(ls behave7*.jar | head -1)
          mv "$JAR_FILE" behave-${{ env.version }}.jar

      # - name: Create Release
      #   uses: ncipollo/release-action@v1
      #   with:
      #     name: "${{ env.version }} (${{ env.date }})"
      #     artifacts: |
      #       release-artifacts/behave7-jar/*.jar
      #       release-artifacts/windows-zip-signed/**/*.zip
      #       release-artifacts/mac-app-zip/**/*.zip
      #       release-artifacts/debian-package/**/*.deb
      #       release-artifacts/site/**/*
      #     artifactContentType: application/octet-stream
      #     tag: ${{ github.ref }}
      #     makeLatest: true
      #     body: |
      #       # Behave 7 Release ${{ env.version }}

      #       Released on ${{ env.date }}

      #       ## Downloads

      #       ### Desktop Applications
      #       - **Windows**: `behave-*-windows-amd64.zip` (signed)
      #       - **macOS (Intel)**: `behave-*-mac-amd64.zip`
      #       - **macOS (Apple Silicon)**: `behave-*-mac-aarch64.zip`
      #       - **Linux**: `behave-*.deb`

      #       ### JAR File
      #       - **Universal JAR**: `behave-${{ env.version }}.jar`

      #       ## Installation

      #       ### Desktop Apps
      #       Download and extract the appropriate package for your platform.

      #       ### JAR File
      #       Requires Java 17 or later:
      #       ```bash
      #       java -jar behave-${{ env.version }}.jar
      #       ```
