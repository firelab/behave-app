name: Package with Conveyor

on:
  workflow_dispatch:
    inputs:
      platform:
        description: 'Target platform'
        required: true
        default: 'windows'
        type: choice
        options:
          - windows
          - mac
          - linux
      arch:
        description: 'Architecture (for macOS only)'
        required: false
        type: choice
        options:
          - mac.amd64
          - mac.aarch64
  workflow_call:
    inputs:
      platform:
        description: 'Target platform'
        required: false
        default: 'windows'
        type: string
      arch:
        description: 'Architecture (for macOS only: mac.amd64 or mac.aarch64)'
        required: false
        type: string
    secrets:
      CONVEYOR_ROOT_KEY:
        required: false
      APPLE_SIGNING_KEY:
        required: false
      APPLE_SIGNING_P12_ENCODED:
        required: false
      MAC_NOTARY_ISSUER:
        required: false
      MAC_NOTARY_KEY:
        required: false
      MAC_NOTARY_PRIVATE_KEY_ENCODED:
        required: false

jobs:
  package:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: behave7-jar
          path: projects/behave/target/


      #### WINDOWS SIGNING ####
      - name: Build package with Conveyor
        uses: hydraulic-software/conveyor/actions/build@v21.1
        if: ${{ contains(inputs.platform || 'windows-zip', 'windows') }}
        with:
          signing_key: ${{ secrets.CONVEYOR_ROOT_KEY }}
          agree_to_license: 1
          command: make windows-zip
          extra_flags: -f projects/behave/conveyor.windows-ci.conf


      #### APPLE SIGNING ####
      - name: Setup Apple certificate for macOS Signing / Notarization
        if: ${{ contains(inputs.platform || '', 'mac') }}
        env:
          APPLE_SIGNING_P12_ENCODED: ${{ secrets.APPLE_SIGNING_P12_ENCODED }}
          MAC_NOTARY_PRIVATE_KEY_ENCODED: ${{ secrets.MAC_NOTARY_PRIVATE_KEY_ENCODED }}
        run: |
          cd ${{ github.workspace }}
          mkdir -p projects/behave/.env

          # Decode and save the P12 Certificate
          echo "${{ env.APPLE_SIGNING_P12_ENCODED }}" | base64 --decode > ${{ github.workspace }}/projects/behave/.env/apple.p12
          echo "APPLE_SIGNING_KEY_PATH=${{ github.workspace }}/projects/behave/.env/apple.p12" >> $GITHUB_ENV

          # Decode and save the P8 Notary
          echo "${{ env.MAC_NOTARY_PRIVATE_KEY_ENCODED }}" | base64 --decode > ${{ github.workspace }}//projects/behave/.env/AuthKey.p8
          echo "MAC_NOTARY_PRIVATE_KEY_PATH=${{ github.workspace }}/projects/behave/.env/AuthKey.p8" >> $GITHUB_ENV

      - name: Build package with Conveyor
        if: ${{ contains(inputs.platform || '', 'mac') }}
        uses: hydraulic-software/conveyor/actions/build@v21.1
        env:
          APPLE_SIGNING_KEY: ${{ secrets.APPLE_SIGNING_KEY }}
          MAC_NOTARY_ISSUER: ${{ secrets.MAC_NOTARY_ISSUER }}
          MAC_NOTARY_KEY: ${{ secrets.MAC_NOTARY_KEY }}
        with:
          signing_key: ${{ secrets.CONVEYOR_ROOT_KEY }}
          agree_to_license: 1
          command: make notarized-mac-zip
          extra_flags: -f projects/behave/conveyor.macos-ci.conf ${{ inputs.arch && format('-Kapp.machines={0}', inputs.arch) || '' }}


      #### LINUX SIGNING ####
      - name: Build package with Conveyor
        if: ${{ contains(inputs.platform || '', 'linux') }}
        uses: hydraulic-software/conveyor/actions/build@v21.1
        with:
          signing_key: ${{ secrets.CONVEYOR_ROOT_KEY }}
          agree_to_license: 1
          command: make debian-package
          extra_flags: -f projects/behave/conveyor.linux-ci.conf

      - name: Ensure version has v prefix in filename
        run: |
          find output -name "*.zip" -type f | while read -r file; do
            dir=$(dirname "$file")
            name=$(basename "$file")

            # Check if filename has a version without v prefix (e.g., name-1.2.3-platform.zip)
            if [[ "$name" =~ ^(.+)-([0-9]+\.[0-9]+\.[0-9]+)(-.*)?\.zip$ ]]; then
              prefix="${BASH_REMATCH[1]}"
              version="${BASH_REMATCH[2]}"
              suffix="${BASH_REMATCH[3]}"
              new_name="${prefix}-v${version}${suffix}.zip"
              echo "Renaming: $name -> $new_name"
              mv "$file" "$dir/$new_name"
            else
              echo "Filename already has v prefix or doesn't match pattern: $name"
            fi
          done

      - name: Upload Windows package
        if: ${{ contains(inputs.platform || 'windows-zip', 'windows') }}
        uses: actions/upload-artifact@v4
        with:
          name: windows-zip
          path: output/**/*windows*.zip
          retention-days: 5

      - name: Upload macOS package
        if: ${{ contains(inputs.platform || '', 'mac') }}
        uses: actions/upload-artifact@v4
        with:
          name: mac-zip-${{ inputs.arch == 'mac.aarch64' && 'aarch64' || 'amd64' }}
          path: output/**/*mac*.zip
          retention-days: 5

      - name: Upload Linux package
        if: ${{ contains(inputs.platform || '', 'linux') }}
        uses: actions/upload-artifact@v4
        with:
          name: linux-app
          path: output/**/*.deb
          retention-days: 5
