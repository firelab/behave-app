name: Create Release

on: push
#  push:
#    tags:
#      - '*'
#  workflow_dispatch:
#  workflow_call:

jobs:
  # Get the version from the latest tag
  get-version:
    runs-on: ubuntu-latest
    outputs:
      build_version: ${{ steps.version.outputs.build_version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest tag
        id: version
        run: |
          # Get the latest tag, or use the current ref if it's a tag
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=$(echo "${{ github.ref }}" | sed 's|refs/tags/||')
          else
            VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          fi
          echo "build_version=$VERSION" >> $GITHUB_OUTPUT
          echo "Detected version: $VERSION"

  # Build the JAR first
  build:
    uses: ./.github/workflows/jar-only.yml
    secrets:
      VMS_URL: ${{ secrets.VMS_URL }}
      VMS_AUTH_TOKEN: ${{ secrets.VMS_AUTH_TOKEN }}

  # Package for Windows
  package-windows:
    needs: [build]
    uses: ./.github/workflows/conveyor.yml
    with:
      platform: windows-zip
    secrets:
      CONVEYOR_ROOT_KEY: ${{ secrets.CONVEYOR_ROOT_KEY }}

  # Sign the Windows package
  sign:
    needs: [get-version, package-windows]
    uses: ./.github/workflows/sign.yml
    with:
      version: ${{ needs.get-version.outputs.build_version }}
    secrets:
      AZURE_SIGNING_ALIAS: ${{ secrets.AZURE_SIGNING_ALIAS }}
      AZURE_SIGNING_REGION: ${{ secrets.AZURE_SIGNING_REGION }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}

  # Create the release
  create-release:
    needs: [get-version, build, sign]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set version
        run: |
          echo "version=${{ needs.get-version.outputs.build_version }}" >> "$GITHUB_ENV"
          DATE=$(date '+%Y-%m-%d')
          echo "date=$DATE" >> "$GITHUB_ENV"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts/

      - name: Display structure
        run: ls -R release-artifacts/

      - name: Rename JAR with version
        run: |
          cd release-artifacts/behave7-jar
          mv behave7.jar behave-${{ env.version }}.jar

    #   - name: Create Release
    #     uses: ncipollo/release-action@v1
    #     with:
    #       name: "${{ env.version }} (${{ env.date }})"
    #       artifacts: |
    #         release-artifacts/behave7-jar/*.jar
    #         release-artifacts/windows-zip-signed/**/*.zip
    #       artifactContentType: application/octet-stream
    #       tag: ${{ github.ref }}
    #       makeLatest: true
    #       body: |
    #         # Behave 7 Release ${{ env.version }}

    #         Released on ${{ env.date }}

    #         ## Downloads

    #         ### Desktop Applications
    #         - **Windows**: `behave-*-windows-amd64.zip` (signed)

    #         ### JAR File
    #         - **Universal JAR**: `behave-${{ env.version }}.jar`

    #         ## Installation

    #         ### Desktop Apps
    #         Download and extract the appropriate package for your platform.

    #         ### JAR File
    #         Requires Java 17 or later:
    #         ```bash
    #         java -jar behave-${{ env.version }}.jar
    #         ```
